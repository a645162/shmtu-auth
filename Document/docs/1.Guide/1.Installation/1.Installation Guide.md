# 安装指南

本文档提供了 shmtu-auth 工具的详细安装指南，适用于不同的平台和使用场景。

## 系统要求

### 基本要求

- **Python 版本**: Python 3.8 或更高版本
- **操作系统**: Windows 7+, macOS 10.12+, Linux (任意现代发行版)
- **内存**: 至少 100MB 可用内存
- **网络**: 能够访问上海海事大学校园网

### GUI 版本额外要求

- **Python 版本**: Python 3.8 或更高版本（推荐 3.13）
- **显示环境**: 支持图形界面的桌面环境
- **依赖库**: PySide6 及相关 Qt 组件

⚠️ **注意**: macOS x64 (Intel) 平台下 Python 版本必须 ≤ 3.11，否则无法安装 PySide6。因为Apple基本停止生产新的Intel设备，因此软件基本上都不再针对Intel推出新版本了~

## 安装方式

### 1. 预编译程序（推荐）

这是最简单的安装方式，适合大多数用户。

#### 下载步骤

1. 访问 [GitHub Releases](https://github.com/a645162/shmtu-auth/releases)
2. 选择最新版本
3. 根据您的操作系统下载对应的文件：
   - **Windows**: `shmtu-auth-windows-x64.exe`
   - **macOS**: `shmtu-auth-macos-x64` 或 `shmtu-auth-macos-arm64`
   - **Linux**: `shmtu-auth-linux-x64`

#### 使用方法

**Windows:**

```cmd
# 直接运行
shmtu-auth-windows-x64.exe

# 或者使用配置文件
shmtu-auth-windows-x64.exe -t config.toml
```

**macOS/Linux:**

```bash
# 添加执行权限
chmod +x shmtu-auth-macos-x64

# 运行程序
./shmtu-auth-macos-x64

# 或者使用配置文件
./shmtu-auth-macos-x64 -t config.toml
```

### 2. Python 包安装

适合有 Python 环境的用户，支持命令行和编程使用。

#### 从 PyPI 安装

```bash
# 安装最新版本
pip install shmtu-auth

# 指定版本安装
pip install shmtu-auth==2.1.0

# 升级到最新版本
pip install --upgrade shmtu-auth
```

#### 使用方法

```bash
# 命令行使用
shmtu-auth

# 使用配置文件
shmtu-auth -t config.toml

# Python 代码中使用
python -c "from shmtu_auth.main_start import main; main()"
```

### 3. Docker 部署

适合服务器环境和容器化部署。

#### 拉取镜像

```bash
# 从 Docker Hub 拉取（国外）
docker pull a645162/shmtu-auth:latest

# 从阿里云 ACR 拉取（国内，推荐）
docker pull registry.cn-shanghai.aliyuncs.com/a645162/shmtu-auth:latest
```

#### 运行容器

```bash
# 使用环境变量配置
docker run -d \
  --name shmtu-auth \
  -e SHMTU_AUTH_USER_LIST="student_id1;student_id2" \
  -e SHMTU_AUTH_USER_PWD_student_id1="password1" \
  -e SHMTU_AUTH_USER_PWD_student_id2="password2" \
  -e SHMTU_AUTH_TIME_INTERVAL=30 \
  registry.cn-shanghai.aliyuncs.com/a645162/shmtu-auth:latest

# 使用配置文件
docker run -d \
  --name shmtu-auth \
  -v /path/to/config.toml:/app/config.toml \
  registry.cn-shanghai.aliyuncs.com/a645162/shmtu-auth:latest
```

#### Docker Compose

创建 `docker-compose.yml` 文件：

```yaml
services:
  shmtu-auth:
    image: registry.cn-shanghai.aliyuncs.com/a645162/shmtu-auth:latest
    container_name: shmtu-auth
    restart: unless-stopped
    environment:
      - SHMTU_AUTH_USER_LIST=student_id1;student_id2
      - SHMTU_AUTH_USER_PWD_student_id1=password1
      - SHMTU_AUTH_USER_PWD_student_id2=password2
      - SHMTU_AUTH_TIME_INTERVAL=30
      - SHMTU_MACHINE_NAME=MyServer
    # 或者使用配置文件
    # volumes:
    #   - ./config.toml:/app/config.toml
```

运行：

```bash
docker-compose up -d
```

### 4. 源码安装

适合开发者和需要自定义的用户。

#### 克隆仓库

```bash
git clone https://github.com/a645162/shmtu-auth.git
cd shmtu-auth
```

#### 创建虚拟环境（推荐）

**使用 uv（推荐）:**

```bash
# 安装 uv
pip install uv

# 创建虚拟环境
uv venv
source .venv/bin/activate  # Linux/macOS
# 或
.venv\Scripts\activate     # Windows
```

**使用 conda:**

```bash
conda create -n shmtu-auth python=3.13 -y
conda activate shmtu-auth
```

**使用 venv:**

```bash
python -m venv venv
source venv/bin/activate   # Linux/macOS
# 或
venv\Scripts\activate      # Windows
```

#### 安装依赖

```bash
# 基础依赖
pip install.py
```

#### 运行程序

```bash
# 命令行版本
python src/start_cli.py

# GUI 版本
python src/shmtu_auth/main_gui.py

# 使用配置文件
python src/start_cli.py -t config.toml
```

## GUI 版本安装

### Windows 平台

1. 下载 `shmtu-auth-gui-windows-x64.exe`
2. 双击运行即可，程序会自动启动到系统托盘

### macOS 平台

1. 下载 `shmtu-auth-gui-macos.dmg`
2. 挂载 DMG 文件并将应用拖拽到 Applications 文件夹
3. 首次运行需要在系统偏好设置中允许该应用

### Linux 平台

```bash
# 安装依赖（Ubuntu/Debian）
sudo apt-get update
sudo apt-get install python3-pip python3-venv

# 安装 GUI 依赖
sudo apt-get install python3-tk python3-dev

# 从源码安装
git clone https://github.com/a645162/shmtu-auth.git
cd shmtu-auth
python3 -m venv venv
source venv/bin/activate
pip install -r requirements/r-gui-requirements.txt
python src/shmtu_auth/main_gui.py
```

## 验证安装

### 检查版本

```bash
# Python 包安装
shmtu-auth --version

# 源码安装
python src/start_cli.py --version
```

### 基本功能测试

```bash
# 检查帮助信息
shmtu-auth --help

# 测试配置文件加载
shmtu-auth -t /path/to/config.toml
```

## 常见问题

### 依赖问题

**问题**: `ImportError: No module named 'xxx'`

**解决方案**:

```bash
# 重新安装依赖
pip install --upgrade -r requirements.txt

# 或者强制重新安装
pip install --force-reinstall shmtu-auth
```

### 权限问题

**问题**: Linux/macOS 下无法执行程序

**解决方案**:

```bash
chmod +x shmtu-auth-linux-x64
```

### GUI 问题

**问题**: GUI 无法启动或显示异常

**解决方案**:

1. 检查 Python 版本是否符合要求
2. 确保安装了完整的 GUI 依赖
3. 在 Linux 下确保有桌面环境

**Windows AMD 显卡用户注意**: 程序已全局关闭 Mica 云母特效以避免显示问题。

### 网络问题

**问题**: 无法连接到认证服务器

**解决方案**:

1. 检查网络连接
2. 确认在校园网环境中
3. 检查防火墙设置

## 卸载

### Python 包卸载

```bash
pip uninstall shmtu-auth
```

### Docker 卸载

```bash
# 停止并删除容器
docker stop shmtu-auth
docker rm shmtu-auth

# 删除镜像
docker rmi a645162/shmtu-auth:latest
```

### 源码安装卸载

直接删除克隆的项目目录即可。

## 更新

### Python 包更新

```bash
pip install --upgrade shmtu-auth
```

### Docker 更新

```bash
# 拉取最新镜像
docker pull registry.cn-shanghai.aliyuncs.com/a645162/shmtu-auth:latest

# 重新创建容器
docker stop shmtu-auth
docker rm shmtu-auth
# 然后重新运行 docker run 命令
```

### 预编译程序更新

重新下载最新版本的预编译程序替换旧版本即可。
