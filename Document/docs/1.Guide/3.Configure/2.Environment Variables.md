# 环境变量配置指南

本文档详细说明了 shmtu-auth 支持的所有环境变量配置选项。

## 基本配置

### 用户认证配置（必需）

#### SHMTU_AUTH_USER_LIST

用户列表，多个用户之间用分号（`;`）分隔。

**格式**: `{学号1};{学号2};{学号3}`

**示例**:
```bash
# Linux/macOS
export SHMTU_AUTH_USER_LIST="202012345;202012346"

# Windows CMD
set SHMTU_AUTH_USER_LIST=202012345;202012346

# Windows PowerShell
$env:SHMTU_AUTH_USER_LIST="202012345;202012346"
```

#### SHMTU_AUTH_USER_PWD_{学号}

对应学号的密码配置。需要为每个用户单独设置。

**格式**: `SHMTU_AUTH_USER_PWD_{具体学号}={密码}`

**示例**:

```bash
# Linux/macOS
export SHMTU_AUTH_USER_PWD_202012345="your_password_1"
export SHMTU_AUTH_USER_PWD_202012346="your_password_2"

# Windows CMD
set SHMTU_AUTH_USER_PWD_202012345=your_password_1
set SHMTU_AUTH_USER_PWD_202012346=your_password_2

# Windows PowerShell
$env:SHMTU_AUTH_USER_PWD_202012345="your_password_1"
$env:SHMTU_AUTH_USER_PWD_202012346="your_password_2"
```

#### SHMTU_AUTH_USER_PWD_ENCRYPT_{学号}

指定对应学号的密码是否为加密格式。设置为 `1` 表示密码已加密，不设置或设置为其他值表示明文密码。

**格式**: `SHMTU_AUTH_USER_PWD_ENCRYPT_{具体学号}=1`

**示例**:

```bash
# 如果用户 202012345 的密码是加密的
export SHMTU_AUTH_USER_PWD_ENCRYPT_202012345=1
```

## 网络配置

### SHMTU_AUTH_TIME_INTERVAL

认证状态检测的时间间隔，单位为秒。

**默认值**: `60`

**示例**:

```bash
# 设置每30秒检测一次
export SHMTU_AUTH_TIME_INTERVAL=30
```

### SHMTU_AUTH_NETWORK_CHECK_RETRY_TIMES

网络检查的重试次数。

**默认值**: `3`

**示例**:

```bash
export SHMTU_AUTH_NETWORK_CHECK_RETRY_TIMES=5
```

### SHMTU_AUTH_NETWORK_CHECK_RETRY_TIME_INTERVAL

网络检查重试的时间间隔，单位为秒。

**默认值**: `30`

**示例**:

```bash
export SHMTU_AUTH_NETWORK_CHECK_RETRY_TIME_INTERVAL=15
```

### SHMTU_AUTH_USER_AGENT

自定义 HTTP 请求的 User-Agent 字符串。

**默认值**: `Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.2.1 Safari/605.1.15`

**示例**:

```bash
export SHMTU_AUTH_USER_AGENT="Custom-Auth-Client/1.0"
```

## 系统配置

### SHMTU_MACHINE_NAME

设置机器名称，用于日志记录和标识。

**示例**:

```bash
export SHMTU_MACHINE_NAME="MyServer"
```

### DOCKER_MODE

指示程序运行在 Docker 环境中。Docker 镜像会自动设置此变量。

**示例**:

```bash
export DOCKER_MODE=1
```

## 通知配置

### SHMTU_AUTH_WEBHOOK_WEWORK

企业微信机器人的 WebHook URL，用于发送认证状态通知。

**示例**:

```bash
export SHMTU_AUTH_WEBHOOK_WEWORK="https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=your_key"
```

### SHMTU_WEBHOOK_SLEEP_TIME_START

WebHook 通知的免打扰开始时间。

**格式**: `HH:MM`

**默认值**: `23:00`

**示例**:

```bash
export SHMTU_WEBHOOK_SLEEP_TIME_START="22:30"
```

### SHMTU_WEBHOOK_SLEEP_TIME_END

WebHook 通知的免打扰结束时间。

**格式**: `HH:MM`

**默认值**: `7:00`

**示例**:

```bash
export SHMTU_WEBHOOK_SLEEP_TIME_END="8:00"
```

## 配置示例

### 单用户配置

```bash
#!/bin/bash
# single_user_config.sh

export SHMTU_AUTH_USER_LIST="202012345"
export SHMTU_AUTH_USER_PWD_202012345="your_password"
export SHMTU_AUTH_TIME_INTERVAL=30
export SHMTU_MACHINE_NAME="MyLaptop"
```

### 多用户配置

```bash
#!/bin/bash
# multi_user_config.sh

export SHMTU_AUTH_USER_LIST="202012345;202012346;202012347"
export SHMTU_AUTH_USER_PWD_202012345="password1"
export SHMTU_AUTH_USER_PWD_202012346="password2"
export SHMTU_AUTH_USER_PWD_202012347="password3"
export SHMTU_AUTH_TIME_INTERVAL=60
export SHMTU_MACHINE_NAME="SharedServer"
export SHMTU_AUTH_WEBHOOK_WEWORK="https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=your_key"
```

### Docker 环境配置

```bash
#!/bin/bash
# docker_run.sh

docker run -d \
  --name shmtu-auth \
  --restart unless-stopped \
  -e SHMTU_AUTH_USER_LIST="202012345;202012346" \
  -e SHMTU_AUTH_USER_PWD_202012345="password1" \
  -e SHMTU_AUTH_USER_PWD_202012346="password2" \
  -e SHMTU_AUTH_TIME_INTERVAL=30 \
  -e SHMTU_MACHINE_NAME="DockerServer" \
  -e SHMTU_AUTH_NETWORK_CHECK_RETRY_TIMES=5 \
  registry.cn-shanghai.aliyuncs.com/a645162/shmtu-auth:latest
```

## Windows 批处理文件配置

### 基本配置 (config.bat)

```batch
@echo off
REM Windows 环境变量配置

set SHMTU_AUTH_USER_LIST=202012345;202012346
set SHMTU_AUTH_USER_PWD_202012345=password1
set SHMTU_AUTH_USER_PWD_202012346=password2
set SHMTU_AUTH_TIME_INTERVAL=30
set SHMTU_MACHINE_NAME=WindowsPC

REM 运行程序
shmtu-auth.exe
```

### PowerShell 配置 (config.ps1)

```powershell
# PowerShell 环境变量配置

$env:SHMTU_AUTH_USER_LIST = "202012345;202012346"
$env:SHMTU_AUTH_USER_PWD_202012345 = "password1"
$env:SHMTU_AUTH_USER_PWD_202012346 = "password2"
$env:SHMTU_AUTH_TIME_INTERVAL = 30
$env:SHMTU_MACHINE_NAME = "WindowsPC"

# 运行程序
& ".\shmtu-auth.exe"
```

## 配置优先级

配置的读取优先级如下（从高到低）：

1. **命令行参数** - `-t` 或 `--toml` 指定的 TOML 配置文件
2. **TOML 配置文件** - 程序自动查找的配置文件
3. **环境变量** - 系统环境变量
4. **默认值** - 程序内置的默认值

## 安全注意事项

### 密码保护

1. **避免明文存储**: 生产环境中避免在脚本中明文写入密码
2. **使用配置文件**: 敏感信息优先使用 TOML 配置文件，并设置适当的文件权限
3. **环境变量管理**: 使用系统的密钥管理服务或环境变量管理工具

### 文件权限

```bash
# 设置配置文件权限（仅所有者可读写）
chmod 600 config.toml
chmod 600 config.sh

# 设置目录权限
chmod 700 ~/.shmtu-auth/
```

### Docker 密钥管理

```bash
# 使用 Docker secrets（Docker Swarm）
echo "your_password" | docker secret create shmtu_auth_pwd -

# 使用环境变量文件
echo "SHMTU_AUTH_USER_PWD_202012345=your_password" > .env
docker run --env-file .env shmtu-auth
```

## 验证配置

### 检查环境变量

```bash
# Linux/macOS
echo $SHMTU_AUTH_USER_LIST
echo $SHMTU_AUTH_TIME_INTERVAL

# Windows CMD
echo %SHMTU_AUTH_USER_LIST%
echo %SHMTU_AUTH_TIME_INTERVAL%

# Windows PowerShell
echo $env:SHMTU_AUTH_USER_LIST
echo $env:SHMTU_AUTH_TIME_INTERVAL
```

### 测试配置

```bash
# 使用 dry-run 模式测试配置（如果支持）
shmtu-auth --test-config

# 或者查看程序启动日志
shmtu-auth --verbose
```

## 故障排除

### 常见问题

1. **用户信息未找到**: 检查 `SHMTU_AUTH_USER_LIST` 是否正确设置
2. **密码错误**: 确认 `SHMTU_AUTH_USER_PWD_{学号}` 与实际学号匹配
3. **认证频繁**: 适当增加 `SHMTU_AUTH_TIME_INTERVAL` 的值
4. **网络超时**: 增加 `SHMTU_AUTH_NETWORK_CHECK_RETRY_TIMES` 和调整重试间隔

### 调试模式

```bash
# 启用详细日志
export SHMTU_AUTH_DEBUG=1
export SHMTU_AUTH_LOG_LEVEL=DEBUG

# 运行程序
`shmtu-auth`
