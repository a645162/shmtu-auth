# TOML 配置文件详解

TOML（Tom's Obvious, Minimal Language）是一种简单易读的配置文件格式。shmtu-auth 支持通过 TOML 配置文件进行详细的参数配置。

## 配置文件使用

### 指定配置路径

您可以通过命令行 `-t` 或 `--toml` 参数指定 TOML 配置文件的路径。

```bash
# 使用相对路径
shmtu-auth -t config.toml

# 使用绝对路径
shmtu-auth -t /path/to/your/config.toml

# Windows 示例
shmtu-auth.exe -t "C:\configs\shmtu-auth.toml"
```

### 配置文件读取顺序

程序按照以下优先级读取配置文件：

1. **命令行指定的路径** - 如果使用 `-t` 参数指定了配置文件，则**只**读取该文件
2. **当前目录的 config.toml** - `./config.toml`
3. **config 子目录** - `./config/config.toml`

如果以上路径都没有找到配置文件，程序将使用环境变量和默认值。

### 创建配置文件

您可以从项目中复制示例配置文件：

```bash
# 复制默认配置文件
cp src/shmtu_auth/config/config.toml ./config.toml

# 或者手动创建
touch config.toml
```

## 完整配置文件示例

```toml
# shmtu-auth 配置文件
# 版本: 2.1.0

[global]
# 机器名称，用于标识当前设备（可选）
SHMTU_MACHINE_NAME = "MyLaptop"

[Network]
# 网络检查重试次数
SHMTU_AUTH_NETWORK_CHECK_RETRY_TIMES = 3
# 网络检查重试间隔（秒）
SHMTU_AUTH_NETWORK_CHECK_RETRY_TIME_INTERVAL = 30

[Auth]
# 认证状态检测间隔（秒）
SHMTU_AUTH_TIME_INTERVAL = 60

[User]
# 用户列表，多个用户用分号分隔
SHMTU_AUTH_USER_LIST = "202012345;202012346"
# 各用户的密码配置
SHMTU_AUTH_USER_PWD_202012345 = "password1"
SHMTU_AUTH_USER_PWD_202012346 = "password2"
# 密码加密标志（可选，设置为1表示密码已加密）
SHMTU_AUTH_USER_PWD_ENCRYPT_202012345 = 0
SHMTU_AUTH_USER_PWD_ENCRYPT_202012346 = 0

[Notify]
# 企业微信机器人 WebHook URL（可选）
SHMTU_AUTH_WEBHOOK_WEWORK = "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=your-key"
# 通知免打扰时间段
SHMTU_WEBHOOK_SLEEP_TIME_START = "23:00"
SHMTU_WEBHOOK_SLEEP_TIME_END = "7:00"

[Advanced]
# 自定义 User-Agent（可选）
SHMTU_AUTH_USER_AGENT = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
# 调试模式（可选）
SHMTU_AUTH_DEBUG = 0
```

## 配置项详细说明

### [global] 全局配置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `SHMTU_MACHINE_NAME` | string | `""` | 机器名称，用于日志标识和区分不同设备 |

**示例**:

```toml
[global]
SHMTU_MACHINE_NAME = "办公室电脑"
```

### [Network] 网络配置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `SHMTU_AUTH_NETWORK_CHECK_RETRY_TIMES` | integer | `3` | 网络检查失败时的重试次数 |
| `SHMTU_AUTH_NETWORK_CHECK_RETRY_TIME_INTERVAL` | integer | `30` | 重试间隔时间（秒） |

**示例**:

```toml
[Network]
# 增加重试次数以提高稳定性
SHMTU_AUTH_NETWORK_CHECK_RETRY_TIMES = 5
# 缩短重试间隔以快速恢复
SHMTU_AUTH_NETWORK_CHECK_RETRY_TIME_INTERVAL = 15
```

### [Auth] 认证配置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `SHMTU_AUTH_TIME_INTERVAL` | integer | `60` | 认证状态检测间隔（秒） |

**示例**:

```toml
[Auth]
# 每30秒检查一次网络状态
SHMTU_AUTH_TIME_INTERVAL = 30
```

### [User] 用户配置

| 配置项 | 类型 | 说明 |
|--------|------|------|
| `SHMTU_AUTH_USER_LIST` | string | 用户学号列表，用分号分隔 |
| `SHMTU_AUTH_USER_PWD_{学号}` | string | 对应学号的密码 |
| `SHMTU_AUTH_USER_PWD_ENCRYPT_{学号}` | integer | 密码是否加密（1=加密，0=明文） |

**示例**:

```toml
[User]
# 配置两个用户
SHMTU_AUTH_USER_LIST = "202012345;202098765"
SHMTU_AUTH_USER_PWD_202012345 = "mypassword123"
SHMTU_AUTH_USER_PWD_202098765 = "anotherpassword"
# 第一个用户使用明文密码，第二个用户使用加密密码
SHMTU_AUTH_USER_PWD_ENCRYPT_202012345 = 0
SHMTU_AUTH_USER_PWD_ENCRYPT_202098765 = 1
```

### [Notify] 通知配置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `SHMTU_AUTH_WEBHOOK_WEWORK` | string | `""` | 企业微信机器人 WebHook URL |
| `SHMTU_WEBHOOK_SLEEP_TIME_START` | string | `"23:00"` | 免打扰开始时间 |
| `SHMTU_WEBHOOK_SLEEP_TIME_END` | string | `"7:00"` | 免打扰结束时间 |

**示例**:

```toml
[Notify]
# 配置企业微信通知
SHMTU_AUTH_WEBHOOK_WEWORK = "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxxxxxxx"
# 晚上11点到早上8点不发送通知
SHMTU_WEBHOOK_SLEEP_TIME_START = "23:00"
SHMTU_WEBHOOK_SLEEP_TIME_END = "8:00"
```

### [Advanced] 高级配置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `SHMTU_AUTH_USER_AGENT` | string | 默认浏览器标识 | 自定义 HTTP 请求头 |
| `SHMTU_AUTH_DEBUG` | integer | `0` | 调试模式（1=开启，0=关闭） |

**示例**:

```toml
[Advanced]
# 自定义 User-Agent
SHMTU_AUTH_USER_AGENT = "SHMTU-Auth-Client/2.1.0"
# 开启调试模式
SHMTU_AUTH_DEBUG = 1
```

## 使用场景示例

### 1. 家庭网络配置

```toml
# 家庭网络 - 单用户，较长检测间隔
[global]
SHMTU_MACHINE_NAME = "家里的电脑"

[Auth]
SHMTU_AUTH_TIME_INTERVAL = 120  # 2分钟检查一次

[User]
SHMTU_AUTH_USER_LIST = "你的学号"
SHMTU_AUTH_USER_PWD_你的学号 = "你的密码"

[Network]
SHMTU_AUTH_NETWORK_CHECK_RETRY_TIMES = 3
SHMTU_AUTH_NETWORK_CHECK_RETRY_TIME_INTERVAL = 30
```

### 2. 服务器部署配置

```toml
# 服务器 - 多用户备份，频繁检测
[global]
SHMTU_MACHINE_NAME = "实验室服务器"

[Auth]
SHMTU_AUTH_TIME_INTERVAL = 30  # 30秒检查一次

[User]
SHMTU_AUTH_USER_LIST = "202012345;202012346;202012347"
SHMTU_AUTH_USER_PWD_202012345 = "password1"
SHMTU_AUTH_USER_PWD_202012346 = "password2"
SHMTU_AUTH_USER_PWD_202012347 = "password3"

[Network]
SHMTU_AUTH_NETWORK_CHECK_RETRY_TIMES = 5
SHMTU_AUTH_NETWORK_CHECK_RETRY_TIME_INTERVAL = 15

[Notify]
SHMTU_AUTH_WEBHOOK_WEWORK = "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=server-key"
SHMTU_WEBHOOK_SLEEP_TIME_START = "02:00"
SHMTU_WEBHOOK_SLEEP_TIME_END = "06:00"
```

### 3. Docker 容器配置

```toml
# Docker 容器配置
[global]
SHMTU_MACHINE_NAME = "Docker容器"

[Auth]
SHMTU_AUTH_TIME_INTERVAL = 60

[User]
SHMTU_AUTH_USER_LIST = "学号1;学号2"
SHMTU_AUTH_USER_PWD_学号1 = "密码1"
SHMTU_AUTH_USER_PWD_学号2 = "密码2"

[Network]
# Docker 环境下可能需要更多重试
SHMTU_AUTH_NETWORK_CHECK_RETRY_TIMES = 6
SHMTU_AUTH_NETWORK_CHECK_RETRY_TIME_INTERVAL = 20
```

## 配置文件管理

### 权限设置

为了保护敏感信息，建议设置适当的文件权限：

```bash
# Linux/macOS - 仅所有者可读写
chmod 600 config.toml

# 设置目录权限
chmod 700 ~/.shmtu-auth/
```

### 配置文件备份

```bash
# 创建备份
cp config.toml config.toml.backup.$(date +%Y%m%d)

# 版本控制（去除敏感信息）
git add config.toml.template
```

### 环境特定配置

```bash
# 开发环境
config.dev.toml

# 生产环境
config.prod.toml

# 测试环境
config.test.toml
```

## 验证配置

### 语法检查

```bash
# 使用 Python 验证 TOML 语法
python3 -c "import toml; print('配置文件语法正确' if toml.load('config.toml') else '语法错误')"
```

### 配置测试

```bash
# 使用配置文件运行程序（测试模式）
shmtu-auth -t config.toml --test-config
```

## 常见问题

### 1. 配置文件不生效

**检查项**:

- 文件路径是否正确
- 文件编码是否为 UTF-8
- TOML 语法是否正确

### 2. 密码包含特殊字符

```toml
# 使用双引号包围包含特殊字符的密码
SHMTU_AUTH_USER_PWD_202012345 = "pass@word#123"

# 或使用单引号
SHMTU_AUTH_USER_PWD_202012345 = 'pass@word#123'
```

### 3. 中文字符问题

确保配置文件使用 UTF-8 编码保存：

```bash
# 检查文件编码
file -i config.toml

# 转换编码
iconv -f GBK -t UTF-8 config.toml > config_utf8.toml
```

通过 TOML 配置文件，您可以更灵活地管理 shmtu-auth 的各项参数，提高使用的便利性和安全性。
