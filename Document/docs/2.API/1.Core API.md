# 核心 API 文档

本文档描述了 shmtu-auth 项目的核心 API 接口。

## ShmtuNetAuthCore 类

### 概述

[`ShmtuNetAuthCore`](../../../src/shmtu_auth/src/core/core.py:13) 是校园网认证的核心类，提供了基础的网络认证功能。

### 初始化

```python
from shmtu_auth.src.core.core import ShmtuNetAuthCore

auth_core = ShmtuNetAuthCore()
```

### 主要方法

#### test_net() -> bool

测试网络是否已经通过认证。

**返回值：**

- `bool` - 如果网络已认证返回 `True`，否则返回 `False`

**示例：**

```python
is_online = auth_core.test_net()
if is_online:
    print("网络已认证")
else:
    print("需要进行认证")
```

#### login(user: str, pwd: str, password_encrypt: bool = False) -> tuple[bool, str]

执行校园网登录认证。

**参数：**

- `user` (str) - 学号
- `pwd` (str) - 密码
- `password_encrypt` (bool) - 密码是否为加密格式，默认为 `False`

**返回值：**

- `tuple[bool, str]` - 第一个元素表示是否认证成功，第二个元素是详细信息

**示例：**

```python
success, message = auth_core.login("your_student_id", "your_password")
if success:
    print(f"登录成功: {message}")
else:
    print(f"登录失败: {message}")
```

#### logout() -> tuple[bool, str]

执行校园网登出操作。

**返回值：**

- `tuple[bool, str]` - 第一个元素表示是否操作成功，第二个元素是详细信息

#### get_all_data() -> dict

获取当前认证账号的所有信息。

⚠️ **注意：** 此操作会获取敏感信息，包括用户名和密码，请谨慎使用。

**返回值：**

- `dict` - 包含用户完整信息的字典

## ShmtuNetAuth 类

### 类说明

[`ShmtuNetAuth`](../../../src/shmtu_auth/src/core/shmtu_auth.py:8) 继承自 `ShmtuNetAuthCore`，提供了更高级的认证功能。

### ShmtuNetAuth 方法

#### login_by_list(user_list: list) -> bool

使用用户列表进行批量登录尝试。

**参数：**

- `user_list` (list) - 用户信息列表，每个元素为 `[user_id, password, is_encrypt]`

**返回值：**

- `bool` - 如果任意一个用户登录成功返回 `True`

**示例：**

```python
from shmtu_auth.src.core.shmtu_auth import ShmtuNetAuth

auth = ShmtuNetAuth()
user_list = [
    ["student_id_1", "password_1", False],
    ["student_id_2", "password_2", False]
]

if auth.login_by_list(user_list):
    print("至少一个用户登录成功")
else:
    print("所有用户登录失败")
```

#### check_is_online() -> bool

检查当前网络是否在线（已认证）。

**返回值：**

- `bool` - 网络状态

## 监控模块

### auth_status 模块

#### start_monitor_auth()

启动网络认证状态监控线程。

```python
from shmtu_auth.src.monitor.auth_status import start_monitor_auth

# 启动监控
start_monitor_auth()
```

监控功能特性：

- 定期检查网络连接状态
- 网络断开时自动重新认证
- 支持多用户轮换认证
- 详细的日志记录

## 配置管理

### 环境变量配置

支持以下环境变量：

| 变量名 | 描述 | 默认值 |
|--------|------|--------|
| `SHMTU_AUTH_USER_LIST` | 用户列表，用分号分隔 | - |
| `SHMTU_AUTH_USER_PWD_{学号}` | 对应学号的密码 | - |
| `SHMTU_AUTH_TIME_INTERVAL` | 认证检测间隔（秒） | 60 |
| `SHMTU_MACHINE_NAME` | 机器名称 | - |
| `SHMTU_AUTH_USER_AGENT` | 自定义 User-Agent | - |

### TOML 配置文件

支持通过 TOML 配置文件进行配置，详见 [TOML 配置文档](../1.Guide/5.Configure/1.TOML%20Config.md)。

## GUI 应用

### gui_main_application()

启动图形用户界面。

```python
from shmtu_auth.src.gui.gui_main_application import gui_main_application

# 启动 GUI
gui_main_application()
```

GUI 特性：

- 基于 PySide6 开发
- 支持系统托盘
- 实时状态显示
- 配置管理界面
- 日志查看功能

## 错误处理

### 常见错误类型

1. **网络连接错误** - 当无法连接到认证服务器时
2. **认证失败** - 用户名或密码错误
3. **Query String 无效** - 无法获取有效的认证参数
4. **配置错误** - 配置文件格式错误或缺少必要参数

### 最佳实践

1. **异常处理** - 始终对 API 调用进行异常处理
2. **日志记录** - 使用内置的日志系统记录操作
3. **状态检查** - 在执行认证前先检查网络状态
4. **安全性** - 妥善保管用户凭据，避免明文存储

## 示例代码

### 基本使用示例

```python
from shmtu_auth.src.core.shmtu_auth import ShmtuNetAuth
from shmtu_auth.src.utils.logs import get_logger

logger = get_logger()

def main():
    # 创建认证实例
    auth = ShmtuNetAuth()
    
    # 检查网络状态
    if auth.check_is_online():
        logger.info("网络已连接")
        return
    
    # 尝试登录
    success, message = auth.login("your_student_id", "your_password")
    if success:
        logger.info(f"登录成功: {message}")
    else:
        logger.error(f"登录失败: {message}")

if __name__ == "__main__":
    main()
```

### 持续监控示例

```python
from shmtu_auth.src.monitor.auth_status import start_monitor_auth
from shmtu_auth.src.utils.program_env_config import get_user_list

def main():
    # 检查用户配置
    user_list = get_user_list()
    if not user_list:
        print("未找到用户配置，请设置环境变量或配置文件")
        return
    
    # 启动监控
    print("启动网络认证监控...")
    start_monitor_auth()
    
    # 保持程序运行
    try:
        while True:
            time.sleep(1)
    except KeyboardInterrupt:
        print("监控已停止")

if __name__ == "__main__":
    main()
```
