# 开发指南

本文档为希望参与 shmtu-auth 项目开发或基于此项目进行二次开发的开发者提供详细指导。

## 项目架构

### 目录结构

```bash
shmtu-auth/
├── src/shmtu_auth/           # 主要源代码
│   ├── __init__.py
│   ├── main_gui.py           # GUI 入口点
│   ├── main_start.py         # CLI 入口点
│   ├── version.py            # 版本信息
│   ├── config/               # 配置相关
│   │   ├── config.toml       # 默认配置文件
│   │   └── github/           # GitHub 集成
│   ├── src/                  # 核心功能模块
│   │   ├── core/             # 认证核心逻辑
│   │   │   ├── core.py       # 基础认证类
│   │   │   ├── shmtu_auth.py # 高级认证类
│   │   │   └── query_string.py # 查询字符串处理
│   │   ├── gui/              # 图形界面
│   │   │   ├── gui_main_application.py
│   │   │   ├── common/       # 通用组件
│   │   │   ├── view/         # 界面视图
│   │   │   └── task/         # 后台任务
│   │   ├── monitor/          # 网络监控
│   │   │   └── auth_status.py
│   │   ├── config/           # 配置管理
│   │   │   ├── config_toml.py
│   │   │   └── build_info.py
│   │   └── utils/            # 工具函数
│   │       ├── logs.py       # 日志系统
│   │       ├── env.py        # 环境变量处理
│   │       └── program_env_config.py
├── Build/                    # 构建脚本
├── Document/                 # 文档
├── requirements/             # 依赖文件
├── Assets/                   # 资源文件
└── pyproject.toml           # 项目配置
```

### 核心模块说明

#### 1. 认证核心 (`src/core/`)

- [`core.py`](../../../src/shmtu_auth/src/core/core.py) - 基础认证功能
- [`shmtu_auth.py`](../../../src/shmtu_auth/src/core/shmtu_auth.py) - 高级认证逻辑
- [`query_string.py`](../../../src/shmtu_auth/src/core/query_string.py) - 查询参数处理

#### 2. 监控模块 (`src/monitor/`)

- [`auth_status.py`](../../../src/shmtu_auth/src/monitor/auth_status.py) - 网络状态监控

#### 3. GUI 模块 (`src/gui/`)

- 基于 PySide6 的图形界面
- 采用 QFluentWidgets 设计库
- 支持系统托盘、多界面管理

#### 4. 配置模块 (`src/config/`)

- TOML 配置文件解析
- 环境变量管理
- 构建信息管理

## 开发环境搭建

### 前置要求

- Python 3.8+ (推荐 3.11)
- Git
- IDE (推荐 PyCharm Professional)

### 环境设置

#### 1. 克隆项目

```bash
git clone https://github.com/a645162/shmtu-auth.git
cd shmtu-auth
```

#### 2. 创建虚拟环境

**使用 uv (推荐)**:

```bash
# 安装 uv
pip install uv

# 创建虚拟环境
uv venv

# 激活虚拟环境
# Linux/macOS
source .venv/bin/activate
# Windows
.venv\Scripts\activate
```

**使用 conda**:

```bash
conda create -n shmtu-auth python=3.11
conda activate shmtu-auth
```

#### 3. 安装依赖

```bash
# 基础依赖
pip install -r requirements.txt

# GUI 开发依赖
pip install -r requirements/r-gui-requirements.txt

# 开发工具依赖
pip install -r requirements/r-dev-requirements.txt
```

#### 4. 开发模式安装

```bash
# 以可编辑模式安装项目
pip install -e .
```

### IDE 配置

#### PyCharm 配置

1. **导入项目**: `File` -> `Open` -> 选择项目目录
2. **配置解释器**: `File` -> `Settings` -> `Project` -> `Python Interpreter`
3. **设置运行配置**:
   - CLI 版本: `src/start_cli.py`
   - GUI 版本: `src/shmtu_auth/main_gui.py`

#### VS Code 配置

创建 `.vscode/settings.json`:

```json
{
    "python.pythonPath": ".venv/bin/python",
    "python.linting.enabled": true,
    "python.linting.pylintEnabled": true,
    "python.formatting.provider": "black",
    "python.testing.pytestEnabled": true
}
```

## 代码规范

### 代码风格

项目采用以下代码规范：

- **格式化工具**: Black
- **导入排序**: isort
- **代码检查**: pylint, flake8
- **类型检查**: mypy (可选)

#### 配置示例

**pyproject.toml**:

```toml
[tool.black]
line-length = 88
target-version = ['py38']

[tool.isort]
profile = "black"
multi_line_output = 3

[tool.pylint.messages_control]
disable = "C0111,R0903,R0902"
```

### 命名规范

- **文件名**: 使用下划线分隔 (`auth_status.py`)
- **类名**: 使用 PascalCase (`ShmtuNetAuth`)
- **函数名**: 使用下划线分隔 (`get_user_list`)
- **常量**: 使用大写字母 (`SERVICE_TYPE`)
- **私有方法**: 前缀下划线 (`_internal_method`)

### 文档字符串

```python
def login(self, user: str, pwd: str, password_encrypt: bool = False) -> tuple[bool, str]:
    """
    执行校园网登录认证。
    
    Args:
        user (str): 学号
        pwd (str): 密码
        password_encrypt (bool): 密码是否为加密格式，默认为 False
    
    Returns:
        tuple[bool, str]: 第一个元素表示是否认证成功，第二个元素是详细信息
    
    Raises:
        NetworkError: 当网络连接失败时
        AuthError: 当认证参数无效时
    """
```

## 核心功能开发

### 添加新的认证方法

1. **扩展核心类**:

```python
# src/core/shmtu_auth.py
class ShmtuNetAuth(ShmtuNetAuthCore):
    def custom_login_method(self, params: dict) -> bool:
        """自定义认证方法"""
        # 实现自定义认证逻辑
        pass
```

2. **添加配置支持**:

```python
# src/config/config_toml.py
def parse_custom_config(config_dict: dict):
    """解析自定义配置"""
    pass
```

3. **更新环境变量处理**:

```python
# src/utils/env.py
def get_custom_env(key: str, default: Any = None):
    """获取自定义环境变量"""
    pass
```

### 添加 GUI 界面

1. **创建新界面**:

```python
# src/gui/view/interface/custom_interface.py
from PySide6.QtWidgets import QWidget
from qfluentwidgets import ScrollArea

class CustomInterface(ScrollArea):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setObjectName("CustomInterface")
        self.setupUI()
    
    def setupUI(self):
        """设置界面"""
        pass
```

2. **注册到主窗口**:

```python
# src/gui/view/main_window.py
def addSubInterface(self):
    """添加子界面"""
    self.customInterface = CustomInterface(self)
    self.addSubInterface(
        self.customInterface,
        FluentIcon.SETTING,
        '自定义',
        NavigationItemPosition.BOTTOM
    )
```

### 添加后台任务

1. **创建任务类**:

```python
# src/gui/task/custom_task.py
from PySide6.QtCore import QThread, pyqtSignal

class CustomTask(QThread):
    finished = pyqtSignal(dict)
    
    def run(self):
        """执行后台任务"""
        result = self.do_custom_work()
        self.finished.emit(result)
    
    def do_custom_work(self):
        """具体的工作逻辑"""
        pass
```

2. **在任务中心注册**:

```python
# src/gui/task/task_center.py
class TaskCenter:
    def start_custom_task(self):
        """启动自定义任务"""
        self.custom_task = CustomTask()
        self.custom_task.finished.connect(self.on_custom_task_finished)
        self.custom_task.start()
```

## 测试

### 单元测试

使用 pytest 进行单元测试：

```python
# tests/test_core.py
import pytest
from shmtu_auth.src.core.shmtu_auth import ShmtuNetAuth

class TestShmtuNetAuth:
    def setup_method(self):
        """测试前置设置"""
        self.auth = ShmtuNetAuth()
    
    def test_network_detection(self):
        """测试网络检测功能"""
        result = self.auth.test_net()
        assert isinstance(result, bool)
    
    @pytest.mark.parametrize("user,pwd,expected", [
        ("", "", False),
        ("test", "", False),
        ("", "test", False),
    ])
    def test_login_validation(self, user, pwd, expected):
        """测试登录参数验证"""
        success, _ = self.auth.login(user, pwd)
        assert (success is True) == expected
```

运行测试：

```bash
# 运行所有测试
pytest

# 运行特定测试文件
pytest tests/test_core.py

# 生成覆盖率报告
pytest --cov=shmtu_auth
```

### 集成测试

```python
# tests/test_integration.py
import os
import tempfile
from shmtu_auth.src.config.config_toml import read_config_toml

class TestIntegration:
    def test_config_loading(self):
        """测试配置文件加载"""
        config_content = """
        [global]
        SHMTU_MACHINE_NAME = "test"
        
        [Auth]
        SHMTU_AUTH_TIME_INTERVAL = 30
        """
        
        with tempfile.NamedTemporaryFile(mode='w', suffix='.toml', delete=False) as f:
            f.write(config_content)
            f.flush()
            
            success = read_config_toml(f.name)
            assert success is True
            
        os.unlink(f.name)
```

## 构建和发布

### 本地构建

#### Python 包构建

```bash
# 构建 wheel 包
python -m build

# 本地安装测试
pip install dist/shmtu_auth-*.whl
```

#### 可执行文件构建

**Windows**:

```powershell
# 使用 PyInstaller 构建
.\Build\windows_generate_exe_console.ps1
.\Build\windows_generate_exe_gui.ps1
```

**macOS**:

```bash
# 命令行版本
./Build/macos_generate_console.sh

# GUI 版本
./Build/macos_generate_gui.sh

# 创建 DMG 安装包
./Build/macos_generate_gui_dmg.sh
```

**Linux**:

```bash
./Build/linux_generate_console.sh
```

#### Docker 镜像构建

```bash
# 构建镜像
docker build -t shmtu-auth:dev .

# 多架构构建
docker buildx build --platform linux/amd64,linux/arm64 -t shmtu-auth:dev .
```

### CI/CD 配置

项目使用 GitHub Actions 进行自动化构建：

**.github/workflows/build.yml**:

```yaml
name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller
      - name: Build executable
        run: |
          .\Build\windows_generate_exe_console.ps1
      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: windows-executable
          path: Build/Output/
```

## 贡献指南

### 提交流程

1. **Fork 项目**: 在 GitHub 上 fork 项目到个人账户
2. **创建分支**: `git checkout -b feature/your-feature-name`
3. **开发功能**: 按照代码规范进行开发
4. **编写测试**: 为新功能编写相应的测试
5. **提交代码**:

   ```bash
   git add .
   git commit -m "feat: add your feature description"
   ```

6. **推送分支**: `git push origin feature/your-feature-name`
7. **创建 PR**: 在 GitHub 上创建 Pull Request

### 提交信息规范

使用 [Conventional Commits](https://www.conventionalcommits.org/) 规范：

```bash
<type>[optional scope]: <description>

[optional body]

[optional footer(s)]
```

**类型说明**:

- `feat`: 新功能
- `fix`: 修复 bug
- `docs`: 文档更新
- `style`: 代码格式调整
- `refactor`: 代码重构
- `test`: 测试相关
- `chore`: 构建工具或辅助工具的变动

### 代码审查

所有 PR 都需要经过代码审查：

1. **自动检查**: CI 会自动运行测试和代码检查
2. **人工审查**: 维护者会审查代码质量和设计
3. **修改反馈**: 根据反馈修改代码
4. **合并条件**: 通过所有检查和审查后合并

## 调试指南

### 本地调试

#### 启用调试模式

```bash
# 设置环境变量
export SHMTU_AUTH_DEBUG=1
export SHMTU_AUTH_LOG_LEVEL=DEBUG

# 运行程序
python src/start_cli.py
```

#### IDE 调试配置

**PyCharm 调试配置**:

```python
# Run/Debug Configurations
# Script path: src/start_cli.py
# Parameters: -t config.toml
# Environment variables:
#   SHMTU_AUTH_DEBUG=1
#   SHMTU_AUTH_LOG_LEVEL=DEBUG
```

### 网络请求调试

使用 mitmproxy 抓包分析：

```bash
# 安装 mitmproxy
pip install mitmproxy

# 启动代理
mitmdump -s capture_script.py

# 设置代理环境变量
export HTTP_PROXY=http://localhost:8080
export HTTPS_PROXY=http://localhost:8080
```

### GUI 调试

```python
# 启用 Qt 调试信息
import os
os.environ['QT_LOGGING_RULES'] = '*.debug=true'

# 启用 PySide6 调试
os.environ['QT_DEBUG_PLUGINS'] = '1'
```

## 性能优化

### 代码性能

1. **使用 cProfile 分析**:

   ```bash
   python -m cProfile -o profile.prof src/start_cli.py
   python -c "import pstats; pstats.Stats('profile.prof').sort_stats('cumulative').print_stats(20)"
   ```

2. **内存使用分析**:

   ```bash
   pip install memory-profiler
   python -m memory_profiler src/start_cli.py
   ```

### GUI 性能

1. **减少不必要的重绘**
2. **使用异步任务处理耗时操作**
3. **优化图标和资源加载**

## 扩展开发

### 插件系统

项目支持通过插件扩展功能：

```python
# plugins/custom_plugin.py
class CustomPlugin:
    def __init__(self, app):
        self.app = app
    
    def on_auth_success(self, user_info):
        """认证成功后的回调"""
        pass
    
    def on_auth_failed(self, error_info):
        """认证失败后的回调"""
        pass
```

### API 扩展

```python
# src/api/custom_api.py
from flask import Flask, jsonify
from shmtu_auth.src.core.shmtu_auth import ShmtuNetAuth

app = Flask(__name__)
auth = ShmtuNetAuth()

@app.route('/api/status')
def get_status():
    """获取认证状态"""
    return jsonify({
        'online': auth.check_is_online(),
        'timestamp': time.time()
    })

@app.route('/api/login', methods=['POST'])
def do_login():
    """执行认证"""
    # 实现认证逻辑
    pass
```

## 常见开发问题

### 依赖冲突

```bash
# 查看依赖冲突
pip check

# 使用 pipdeptree 分析依赖树
pip install pipdeptree
pipdeptree
```

### GUI 开发问题

1. **Qt 版本兼容性**: 确保 PySide6 版本与系统兼容
2. **图标资源**: 使用 Qt 资源系统管理图标
3. **线程安全**: GUI 更新必须在主线程进行

### 打包问题

1. **PyInstaller 配置**: 调整 `.spec` 文件解决打包问题
2. **依赖检测**: 手动添加隐藏的依赖项
3. **资源文件**: 确保资源文件正确打包

通过本开发指南，您应该能够顺利开始 shmtu-auth 项目的开发工作。如有疑问，请参考项目的其他文档或提交 Issue。
