# 故障排除指南

本文档提供了使用 shmtu-auth 时可能遇到的常见问题及其解决方案。

## 常见问题分类

### 🔐 认证相关问题

#### 问题1: "用户名或密码为空"

**症状**: 程序提示用户名或密码为空，无法进行认证。

**可能原因**:

- 环境变量 `SHMTU_AUTH_USER_LIST` 未设置
- 对应学号的密码环境变量未设置
- TOML 配置文件中缺少用户配置

**解决方案**:

```bash
# 检查环境变量
echo $SHMTU_AUTH_USER_LIST
echo $SHMTU_AUTH_USER_PWD_你的学号

# 正确设置环境变量
export SHMTU_AUTH_USER_LIST="你的学号"
export SHMTU_AUTH_USER_PWD_你的学号="你的密码"
```

#### 问题2: "Login failed" 或认证失败

**症状**: 程序显示登录失败，用户名密码显示为星号。

**可能原因**:

- 用户名或密码错误
- 账号被锁定或停用
- 网络连接问题
- 认证服务器故障

**解决方案**:

1. **验证凭据**:

   ```bash
   # 手动测试登录（在浏览器中访问）
   # http://ismu.shmtu.edu.cn/
   ```

2. **检查账号状态**:
   - 联系网络中心确认账号状态
   - 确认账号是否欠费或被停用

3. **网络诊断**:

   ```bash
   # 测试到认证服务器的连接
   ping ismu.shmtu.edu.cn
   
   # 测试 HTTPS 连接
   curl -I https://ismu.shmtu.edu.cn:8443/
   ```

#### 问题3: "Query String is Invalid!"

**症状**: 程序无法获取有效的认证参数。

**可能原因**:

- 不在校园网环境中
- 认证服务器响应异常
- 网络被其他认证系统拦截

**解决方案**:

1. **确认网络环境**:

   ```bash
   # 检查当前网络状态
   curl -I http://www.baidu.com
   
   # 访问校园网页面查看响应
   curl -L http://ismu.shmtu.edu.cn/
   ```

2. **手动获取 Query String**:
   - 打开浏览器访问任意外网页面
   - 查看是否跳转到认证页面
   - 检查 URL 中的查询参数

### 🌐 网络连接问题

#### 问题4: "Network Error!"

**症状**: 程序无法连接到认证服务器。

**可能原因**:

- DNS 解析问题
- 防火墙阻止连接
- 代理设置冲突
- SSL/TLS 证书问题

**解决方案**:

1. **DNS 检查**:

   ```bash
   # 测试 DNS 解析
   nslookup ismu.shmtu.edu.cn
   
   # 使用其他 DNS 服务器
   nslookup ismu.shmtu.edu.cn 8.8.8.8
   ```

2. **防火墙检查**:

   ```bash
   # Windows 防火墙
   netsh advfirewall show allprofiles
   
   # Linux iptables
   sudo iptables -L
   
   # 临时禁用防火墙测试
   ```

3. **代理设置**:

   ```bash
   # 检查代理环境变量
   echo $HTTP_PROXY
   echo $HTTPS_PROXY
   
   # 临时清除代理
   unset HTTP_PROXY HTTPS_PROXY
   ```

#### 问题5: 网络检测不准确

**症状**: 程序误判网络状态，频繁进行不必要的认证。

**解决方案**:

1. **调整检测间隔**:

   ```bash
   export SHMTU_AUTH_TIME_INTERVAL=120  # 增加到2分钟
   ```

2. **增加重试次数**:

   ```bash
   export SHMTU_AUTH_NETWORK_CHECK_RETRY_TIMES=5
   export SHMTU_AUTH_NETWORK_CHECK_RETRY_TIME_INTERVAL=10
   ```

### 🖥️ GUI 相关问题

#### 问题6: GUI 无法启动

**症状**: 双击 GUI 程序无响应或出现错误。

**可能原因**:

- 缺少 GUI 运行库
- Python 版本不兼容
- 权限不足
- 依赖库缺失

**解决方案**:

**Windows**:

```cmd
# 检查系统依赖
# 安装 Microsoft Visual C++ Redistributable
# 下载地址：https://support.microsoft.com/en-us/help/2977003/the-latest-supported-visual-c-downloads

# 以管理员身份运行
```

**macOS**:

```bash
# 检查系统偏好设置中的安全性设置
# 系统偏好设置 -> 安全性与隐私 -> 通用
# 允许来自身份不明开发者的应用

# 命令行强制运行
sudo spctl --master-disable
```

**Linux**:

```bash
# 安装 GUI 依赖
sudo apt-get install python3-tk python3-dev libqt5gui5

# 检查显示环境
echo $DISPLAY
export DISPLAY=:0
```

#### 问题7: 系统托盘图标不显示

**症状**: GUI 启动后看不到系统托盘图标。

**解决方案**:

```bash
# Windows：检查任务栏设置
# 设置 -> 个性化 -> 任务栏 -> 选择哪些图标显示在任务栏上

# Linux：安装系统托盘支持
sudo apt-get install libappindicator3-1

# macOS：检查菜单栏设置
```

### 🐳 Docker 相关问题

#### 问题8: Docker 容器无法启动

**症状**: `docker run` 命令执行失败或容器立即退出。

**解决方案**:

1. **检查容器日志**:

   ```bash
   docker logs shmtu-auth
   ```

2. **交互式调试**:

   ```bash
   docker run -it --rm \
     -e SHMTU_AUTH_USER_LIST="你的学号" \
     -e SHMTU_AUTH_USER_PWD_你的学号="你的密码" \
     registry.cn-shanghai.aliyuncs.com/a645162/shmtu-auth:latest \
     /bin/bash
   ```

3. **网络诊断**:

   ```bash
   # 检查容器网络
   docker network ls
   docker inspect bridge
   ```

#### 问题9: Docker 容器网络问题

**症状**: 容器内无法访问校园网认证服务器。

**解决方案**:

```bash
# 使用主机网络模式
docker run -d --name shmtu-auth \
  --network host \
  -e SHMTU_AUTH_USER_LIST="你的学号" \
  -e SHMTU_AUTH_USER_PWD_你的学号="你的密码" \
  registry.cn-shanghai.aliyuncs.com/a645162/shmtu-auth:latest

# 或者自定义网络
docker network create shmtu-net
docker run -d --name shmtu-auth \
  --network shmtu-net \
  # ... 其他参数
```

### ⚙️ 配置相关问题

#### 问题10: TOML 配置文件解析失败

**症状**: 程序提示 "Parse TOML Config Failed!"

**解决方案**:

1. **检查文件格式**:

   ```bash
   # 验证 TOML 语法
   python3 -c "import toml; print(toml.load('config.toml'))"
   ```

2. **常见格式错误**:

   ```toml
   # 错误：缺少引号
   SHMTU_MACHINE_NAME = Machine Name
   
   # 正确
   SHMTU_MACHINE_NAME = "Machine Name"
   
   # 错误：节名重复
   [User]
   SHMTU_AUTH_USER_LIST = "user1"
   [User]  # 重复的节
   
   # 正确：使用唯一的节名
   [User]
   SHMTU_AUTH_USER_LIST = "user1"
   ```

3. **编码问题**:

   ```bash
   # 确保文件使用 UTF-8 编码
   file -i config.toml
   
   # 转换编码
   iconv -f GBK -t UTF-8 config.toml > config_utf8.toml
   ```

### 📊 性能相关问题

#### 问题11: CPU 使用率过高

**症状**: 程序运行时 CPU 占用率异常高。

**解决方案**:

1. **调整检测频率**:

   ```bash
   # 增加检测间隔
   export SHMTU_AUTH_TIME_INTERVAL=300  # 5分钟
   ```

2. **减少重试次数**:

   ```bash
   export SHMTU_AUTH_NETWORK_CHECK_RETRY_TIMES=2
   ```

#### 问题12: 内存占用过大

**症状**: 程序长时间运行后内存占用持续增长。

**解决方案**:

1. **定期重启**:

   ```bash
   # 使用 cron 定期重启程序
   0 3 * * * /usr/bin/killall shmtu-auth && sleep 10 && /usr/bin/shmtu-auth &
   ```

2. **监控资源使用**:

   ```bash
   # 监控内存使用
   ps aux | grep shmtu-auth
   
   # Docker 容器资源限制
   docker run --memory=100m --cpus=0.5 shmtu-auth
   ```

## 日志分析

### 启用详细日志

```bash
# 设置日志级别
export SHMTU_AUTH_LOG_LEVEL=DEBUG

# 或在 TOML 配置中
[Logging]
level = "DEBUG"
```

### 常见日志信息

| 日志信息 | 含义 | 处理建议 |
|---------|------|----------|
| `Already Login!` | 网络已认证 | 正常状态 |
| `Login success.` | 认证成功 | 正常状态 |
| `Login failed` | 认证失败 | 检查用户名密码 |
| `Network Auth Status: False` | 网络未认证 | 等待程序自动认证 |
| `Query String is Invalid!` | 认证参数无效 | 检查网络环境 |
| `No user information found.` | 未找到用户配置 | 检查配置文件 |

### 日志文件位置

```bash
# Linux/macOS
~/.shmtu-auth/logs/

# Windows
%USERPROFILE%\.shmtu-auth\logs\

# Docker
/app/logs/
```

## 联系支持

### 自助诊断工具

```bash
# 创建诊断脚本
cat > diagnose.sh << 'EOF'
#!/bin/bash
echo "=== SHMTU-Auth 诊断报告 ==="
echo "时间: $(date)"
echo "系统: $(uname -a)"
echo ""

echo "=== 网络测试 ==="
ping -c 3 ismu.shmtu.edu.cn
echo ""

echo "=== DNS 解析 ==="
nslookup ismu.shmtu.edu.cn
echo ""

echo "=== 环境变量 ==="
env | grep SHMTU
echo ""

echo "=== 程序版本 ==="
shmtu-auth --version 2>/dev/null || echo "程序未安装或不在PATH中"
EOF

chmod +x diagnose.sh
./diagnose.sh
```

### 问题反馈

如果以上解决方案都无法解决您的问题，请：

1. **收集信息**:
   - 操作系统版本
   - Python 版本
   - 程序版本
   - 错误日志
   - 配置文件（去除敏感信息）

2. **提交 Issue**:
   - GitHub Issues: [https://github.com/a645162/shmtu-auth/issues](https://github.com/a645162/shmtu-auth/issues)
   - 邮箱: <a645162@gmail.com>

3. **提供以下信息**:

   - 问题描述
   - 重现步骤
   - 期望行为
   - 实际行为
   - 错误信息
   - 系统环境

### 社区支持

- **GitHub Discussions**: 技术讨论和经验分享
- **Issue Tracker**: Bug 报告和功能请求
- **Wiki**: 社区维护的文档和教程

## 预防措施

### 定期维护

1. **更新程序**:

   ```bash
   # Python 包
   pip install --upgrade shmtu-auth
   
   # Docker 镜像
   docker pull registry.cn-shanghai.aliyuncs.com/a645162/shmtu-auth:latest
   ```

2. **备份配置**:

   ```bash
   cp config.toml config.toml.backup.$(date +%Y%m%d)
   ```

3. **监控运行状态**:

   ```bash
   # 创建健康检查脚本
   #!/bin/bash
   if ! pgrep -f shmtu-auth > /dev/null; then
       echo "程序未运行，正在重启..."
       shmtu-auth &
   fi
   ```

### 最佳实践

1. **配置管理**: 使用版本控制管理配置文件
2. **权限控制**: 设置适当的文件权限保护敏感信息
3. **监控告警**: 设置监控系统及时发现问题
4. **定期测试**: 定期验证认证功能正常工作
